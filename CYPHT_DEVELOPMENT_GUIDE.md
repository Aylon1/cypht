# Cypht Development Guide

## Table of Contents
1. [Project Structure](#project-structure)
2. [Core Concepts](#core-concepts)
3. [Creating Pages](#creating-pages)
4. [Module Development](#module-development)
5. [Adding Settings](#adding-settings)
6. [Translation](#translation)
7. [Testing](#testing)
8. [Best Practices](#best-practices)

---

## Project Structure

### Key Directories

#### `.github/`
Contains CI/CD configuration for GitHub Actions, including:
- Test automation during merge requests
- Docker image building
- PR/issue/bug report templates

#### `config/`
Configuration management with `.env` file support:
- All config files return arrays
- Takes values from `.env` with default fallbacks
- `Dynamic.php` (auto-generated, not tracked) is the runtime config file
- Generated automatically when `.env` changes

#### `language/`
Translation files for internationalization

#### `lib/`
Core Cypht framework code

#### `modules/`
All application modules. Each module contains:
- **`site.js`**: Module-specific JavaScript
- **`site.css`**: Module-specific CSS
- **`setup.php`**: Module configuration (pages, handlers, outputs, allowed variables)
- **`modules.php`**: Handler and output classes
- **`assets/`**: Optional folder for fonts, images, samples

#### `scripts/`
Utility scripts for:
- Configuration generation
- User account management
- Database table creation
- Development tools

#### `site/`
Production files generated by [`scripts/config_gen.php`](scripts/config_gen.php)

#### `tests/`
PHPUnit and Selenium test suites

#### `third_party/`
Third-party minified libraries

---

## Core Concepts

### Module Architecture

Cypht uses a modular architecture where functionality is organized into self-contained modules. Each module should be:
- **Pluggable**: Can be enabled/disabled independently
- **Self-contained**: Minimal dependencies on other modules
- **Encapsulated**: Functionality stays within module boundaries

### Inter-Module Dependencies

**IMPORTANT**: Modules should depend on the `core` module but avoid dependencies on other modules when possible.

**Example**: The `sievefilters` module depends on `imap` (cannot work without it), but `imap` does NOT depend on `sievefilters`. Sieve-related functionality belongs in the `sievefilters` module, not in `imap`.

**Best Practice**: To extend functionality in another module, define your handler/output to run "before" or "after" the target module's handler/output. Avoid `require`/`include` statements for files from other modules.

### Request Flow

1. **Handler Modules** (`Hm_Handler_*`): Process logic, validate forms, bind data
2. **Output Modules** (`Hm_Output_*`): Generate HTML for display
3. **Authorization**: All pages, POST/GET variables, outputs, and cookies must be explicitly allowed

### Authorization System

Every module's [`setup.php`](modules/account/setup.php) must return an array with:

```php
return array(
    'allowed_pages' => array('page_name'),
    'allowed_output' => array('output_var'),
    'allowed_get' => array('param' => FILTER_DEFAULT),
    'allowed_post' => array('param' => FILTER_VALIDATE_INT),
    'allowed_cookie' => array('cookie_name'),
    'allowed_server' => array('server_var')
);
```

---

## Creating Pages

### Basic Page (URL-accessible, requires reload)

**In `setup.php`:**
```php
setup_base_page('all_messages', 'core');
add_handler('all_messages', 'load_messages', true);
add_output('all_messages', 'print_messages', true);
```

**In `modules.php`:**
```php
class Hm_Handler_load_messages extends Hm_Handler_Module {
    public function process() {
        // Process logic
        // Get data from database/API
        // Pass to output via $this->out('key', $value)
    }
}

class Hm_Output_print_messages extends Hm_Output_Module {
    protected function output() {
        $data = $this->get('key');
        // Build and return HTML
        return '<div>' . $this->trans('Messages') . '</div>';
    }
}
```

**Authorize the page:**
```php
return array(
    'allowed_pages' => array('all_messages'),
    'allowed_output' => array('messages_data')
);
```

### AJAX Page (Asynchronous loading)

**In `setup.php`:**
```php
setup_base_ajax_page('ajax_load_new_messages', 'core');
add_handler('ajax_load_new_messages', 'get_new_messages', true);
add_output('ajax_load_new_messages', 'print_new_messages', true);
```

**In `modules.php`:**
```php
class Hm_Handler_get_new_messages extends Hm_Handler_Module {
    public function process() {
        // Get new messages
        $this->out('new_messages', $messages);
    }
}

class Hm_Output_print_new_messages extends Hm_Output_Module {
    protected function output() {
        $messages = $this->get('new_messages');
        $this->out('ajax_messages', $messages);
    }
}
```

**In `site.js`:**
```javascript
$(function() {
    if (hm_page_name() === 'all_messages') {
        setInterval(function() {
            Hm_Ajax.request(
                [{'name': 'hm_ajax_hook', 'value': 'ajax_load_new_messages'}],
                function(res) {
                    if (res.ajax_messages) {
                        $('#messages_list').append(res.ajax_messages);
                    }
                }
            );
        }, 15000);
    }
});
```

### Handler/Output Positioning

Use the 5th and 6th parameters to control execution order:

```php
// Run after another handler
add_handler('page', 'my_handler', true, 'module', 'other_handler', 'after');

// Run before another handler
add_handler('page', 'my_handler', true, 'module', 'other_handler', 'before');

// Same for outputs
add_output('page', 'my_output', true, 'module', 'other_output', 'after');
```

---

## Module Development

### Creating a New Module

1. Use the `hello_world` module as a template
2. Create module directory in [`modules/`](modules/)
3. Create required files: [`setup.php`](modules/account/setup.php), [`modules.php`](modules/account/modules.php), [`site.js`](modules/account/site.js), [`site.css`](modules/account/site.css)
4. Enable in `.env`: Add to `CYPHT_MODULES` variable

### Handler Module Template

```php
class Hm_Handler_my_handler extends Hm_Handler_Module {
    public function process() {
        // Validate form data
        list($success, $form) = $this->process_form(array('field1', 'field2'));
        
        if ($success) {
            // Process data
            $result = do_something($form['field1']);
            
            // Pass to output
            $this->out('result_key', $result);
            
            // Store in session
            $this->session->set('key', 'value');
            
            // Show message to user
            Hm_Msgs::add('Success message');
        }
    }
}
```

### Output Module Template

```php
class Hm_Output_my_output extends Hm_Output_Module {
    protected function output() {
        // Get data from handler
        $data = $this->get('result_key');
        
        // Get from session
        $session_data = $this->session->get('key', 'default');
        
        // Build HTML
        $html = '<div class="my-class">';
        $html .= '<h3>' . $this->trans('Title') . '</h3>';
        $html .= '<p>' . $this->html_safe($data) . '</p>';
        $html .= '</div>';
        
        return $html;
    }
}
```

### Session Management

```php
// Set session value
$this->session->set('key', 'value');

// Get session value with default
$value = $this->session->get('key', 'default_value');

// Delete session value
$this->session->del('key');
```

### Passing Data

**Handler to Output:**
```php
// In handler
$this->out('my_key', $data);

// In output
$data = $this->get('my_key');
```

**Handler to Handler (via session):**
```php
// In first handler
$this->session->set('temp_data', $value);

// In second handler (must run after first)
$value = $this->session->get('temp_data');
$this->session->del('temp_data'); // Clean up
```

---

## Adding Settings

### Simple Checkbox Setting

**In `setup.php`:**
```php
add_handler('settings', 'process_my_setting', true, 'my_module', 'save_user_settings', 'before');
add_output('settings', 'my_setting_output', true, 'my_module', 'some_other_setting', 'after');
```

**Handler in `modules.php`:**
```php
class Hm_Handler_process_my_setting extends Hm_Handler_Module {
    public function process() {
        function my_setting_callback($val) { 
            return $val; 
        }
        process_site_setting('my_setting_name', $this, 'my_setting_callback', true, true);
    }
}
```

**Output in `modules.php`:**
```php
class Hm_Output_my_setting_output extends Hm_Output_Module {
    protected function output() {
        $settings = $this->get('user_settings');
        $checked = '';
        $reset = '';
        
        if (array_key_exists('my_setting_name', $settings) && $settings['my_setting_name']) {
            $checked = ' checked="checked"';
        } else {
            $reset = '<span class="reset_default_value_checkbox">Reset</span>';
        }
        
        return '<tr class="general_setting">
            <td><label class="form-check-label" for="my_setting_name">' .
                $this->trans('My Setting Label') . '</label></td>
            <td><input class="form-check-input" type="checkbox" ' . $checked .
                ' value="1" id="my_setting_name" name="my_setting_name" />' . $reset . '</td>
        </tr>';
    }
}
```

**Authorize POST variable:**
```php
'allowed_post' => array(
    'my_setting_name' => FILTER_VALIDATE_INT
)
```

**Access setting value:**
```php
$value = $this->user_config->get('my_setting_name');
```

### Settings Section

**In `setup.php`:**
```php
add_handler('settings', 'process_setting_1', true, 'my_module', 'load_user_data', 'after');
add_handler('settings', 'process_setting_2', true, 'my_module', 'load_user_data', 'after');
add_output('settings', 'start_my_section', true, 'my_module', 'some_existing_section', 'after');
add_output('settings', 'my_setting_1', true, 'my_module', 'start_my_section', 'after');
add_output('settings', 'my_setting_2', true, 'my_module', 'my_setting_1', 'after');
```

**Section header output:**
```php
class Hm_Output_start_my_section extends Hm_Output_Module {
    protected function output() {
        return '<tr><td data-target=".my_section_setting" colspan="2" class="settings_subtitle">
            <img alt="" src="' . Hm_Image_Sources::$chevron . '" />
            ' . $this->trans('My Section') . '
        </td></tr>';
    }
}
```

---

## Translation

### Translating Strings

**In Handler Modules:**
```php
// Messages are auto-translated in Hm_Output_msgs::output
Hm_Msgs::add('Your message here');
```

**In Output Modules:**
```php
$this->trans('Your text here');
```

**In JavaScript:**
```javascript
hm_trans('Your text here', 'en'); // Second param optional
```

### Adding New Translations

1. Add string to each file in [`language/`](language/) folder
2. Use language code as filename (e.g., `en.php`, `fr.php`)
3. Add to array with translation or `false` if unknown

```php
// In language/en.php
return array(
    // ... existing translations
    'New String' => 'New String',
);

// In language/fr.php
return array(
    // ... existing translations
    'New String' => 'Nouvelle Chaîne',
);
```

### Adding New Language

1. Duplicate [`language/en.php`](language/)
2. Rename with 2-digit ISO 639 code
3. Update `interface_lang` and `interface_direction` in array
4. Add to `interface_langs()` function
5. Update test: `Hm_Test_Core_Output_Modules::test_lingual_setting`

---

## Testing

### PHPUnit Tests

**Run all tests:**
```bash
php vendor/phpunit/phpunit/phpunit --configuration tests/phpunit/phpunit.xml
```

**Run specific test:**
```bash
php vendor/phpunit/phpunit/phpunit --configuration tests/phpunit/phpunit.xml --filter testMethodName
```

### Selenium Tests

**Install dependencies:**
```bash
cd tests/selenium
pip install -r requirements.txt
```

**Run tests:**
```bash
sh runall.sh
```

### Debugging

**AJAX Requests:**
1. Add `var_dump($data); exit;` in handler
2. Open browser DevTools → Network tab
3. Filter by Fetch/XHR
4. Run the action
5. Click request → Preview/Response tab

**Failed Tests:**
- Console shows file path and line number
- Click path to jump to failing code
- Check recent changes to classes, handlers, or logic

---

## Best Practices

### Security

1. **Always validate input:**
   ```php
   list($success, $form) = $this->process_form(array('field_name'));
   ```

2. **Escape output:**
   ```php
   $this->html_safe($user_input);
   ```

3. **Use request keys for forms:**
   ```php
   <input type="hidden" name="hm_page_key" value="<?php echo Hm_Request_Key::generate(); ?>" />
   ```

### Performance

1. **Cache menu items** - Click reload link below navigation menu to refresh
2. **Minimize database queries** - Batch operations when possible
3. **Use AJAX for dynamic content** - Avoid full page reloads

### Code Organization

1. **Keep modules self-contained** - Avoid cross-module dependencies
2. **Use meaningful names** - Handler/Output class names should be descriptive
3. **Follow positioning conventions** - Use 'before'/'after' for handler/output order
4. **Document complex logic** - Add comments for non-obvious code

### Module Dependencies

- ✅ **DO**: Depend on `core` module
- ✅ **DO**: Use 'before'/'after' to extend other modules
- ❌ **DON'T**: Use `require`/`include` for other module files
- ❌ **DON'T**: Put functionality in wrong module (e.g., Sieve code in IMAP)

### Debugging Tips

1. Check `?page=info` for configuration map showing all handlers/outputs
2. Use browser DevTools Network tab for AJAX debugging
3. Check "Actively Running Terminals" in environment before executing commands
4. Verify all variables are in `allowed_post`/`allowed_get` arrays

---

## Third-Party Integration

### Adding Third-Party Libraries

1. Copy minified file to [`third_party/`](third_party/) directory
2. Add file path in [`Hm_Output_page_js.output`](lib/output.php) (or `Hm_Output_header_css.output` for CSS)
3. Add file in `combine_includes()` function in [`scripts/config_gen.php`](scripts/config_gen.php)

### External Integrations

Cypht is actively used as embedded webmail in **Tiki**. When making changes:
- Review [Tiki-Cypht integration code](https://gitlab.com/tikiwiki/tiki/-/tree/master/lib/cypht)
- Consider impact on upstream integrations
- Be careful with: module updates, layout changes, routing, error messaging, IMAP/SMTP changes
- Request PR review from Victor for major refactorings

---

## Useful Resources

- [IMAP Test Tool](https://github.com/dovecot/imaptest/wiki/About)
- [JMAP Specification](https://jmap.io/spec.html)
- [Sieve Information](http://sieve.info/)
- [Sieve Tutorial (P5R)](https://p5r.uk/blog/2011/sieve-tutorial.html)
- [Fastmail Sieve Help](https://www.fastmail.com/help/technical/sieve.html)
- [Gandi Sieve Tutorial](https://docs.gandi.net/en/gandimail/sieve/sieve_tutorial.html)
- [Travis CI for Beginners](https://docs.travis-ci.com/user/for-beginners/)

---

## Quick Reference

### Common Functions

```php
// Handler
$this->process_form(array('field1', 'field2'))
$this->out('key', $value)
$this->session->set('key', 'value')
$this->session->get('key', 'default')
$this->session->del('key')
$this->user_config->get('setting_name')
Hm_Msgs::add('Message')

// Output
$this->get('key')
$this->trans('Text')
$this->html_safe($text)
Hm_Request_Key::generate()

// JavaScript
hm_page_name()
hm_trans('Text', 'en')
Hm_Ajax.request([{name: 'hm_ajax_hook', value: 'ajax_page'}], callback)
```

### File Locations

- Module setup: [`modules/MODULE_NAME/setup.php`](modules/account/setup.php)
- Module code: [`modules/MODULE_NAME/modules.php`](modules/account/modules.php)
- Module JS: [`modules/MODULE_NAME/site.js`](modules/account/site.js)
- Module CSS: [`modules/MODULE_NAME/site.css`](modules/account/site.css)
- Core handlers: [`lib/framework.php`](lib/framework.php)
- Core outputs: [`lib/output.php`](lib/output.php)
- Config generation: [`scripts/config_gen.php`](scripts/config_gen.php)

---

*This guide is based on the official Cypht development documentation and best practices from the core development team.*